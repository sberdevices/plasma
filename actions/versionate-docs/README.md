# Пакет `@sberdevices/versionate-docs`

Входная точка - скрипт `main.js`. Скрипт пакета должен запускаться из джобы - `.github/workflows/versionate-docs.yml#Versionate script`. Перед запуском необходимо установить пакет:

```bash
npm ci
npx lerna bootstrap
```

## Описание работы

Версионирование документации **фиксирует** версию на момент запуска скрипта, именно поэтому версионирование запускается **до релиза**. Необходимый порядок запуска воркфлоу для корректного версионирования:

-   Версионирование
-   Релиз
-   Сборка актуальной версии документации

Запуск осуществляется при влитии пуллреквеста в мастер-ветку. Скрипт вытаскивает список коммитов с помощью API GitHub (`@actions/github`). После получения коммитов список фильтруется по следующим параметрам (которые можно менять в файле  `actions/versionate-docs/src/commits.ts@filterCommits`):

-   по наличию ключа "docs(package)", с названиями пакетов в круглых скобках;
-   по наличию ключевого слова "[docs]", (в квадратных скобках);

Также необходимо наличие названий пакетов в скобках. Допустимо указывать несколько названий пакетов в скобках:

-   `docs(plasma-ui): ...` ✅
-   `docs(plasma-ui-docs): ...` ✅
-   `feat(plasma-web): ... [docs]` ✅
-   `docs(plasma-web, plasma-ui): ...` ✅
-   `docs: ...` ❌

Найденные пакеты будут сопоставленны с соответствующими им приложениями документации в файле `actions/versionate-docs/src/packages.ts`. При наличии коммитов с подобными признаками будут версионированы приложения документации.

Для фиксирования версии приложение документации собирается, а затем в файл `versionsArchived.js` в соответствующей приложению папке в формате JSON записывается версия и ссылка на билд этой версии. После этого файл коммитится в мастер-ветку, а билд заливается на сервер.

## Дублирование архивной и актуальной версии

Такая проблема возможна, когда после версионирования не релизится новая версия пакета, например:

-   версия пакета `@sberdevices/plasma-ui` - 1.0.0
-   в мастер-ветку попадает коммит, который триггерит версионирование
-   для приложения `@sberdevices/plasma-ui-docs` создается архивная версия 1.0.0
-   релиз проходит без выпуска версии `plasma-ui`, потому что в списке коммитов не было коммитов с типами `feat` или `fix`
-   собирается приложении документации с версией 1.0.0
-   на сайте в выпадающем меню оказывается две версии с одинаковыми называниями 1.0.0 и 1.0.0 (ведущая на архивную) документацию

Проблема исправляется сама по себе после выпуска новой версии пакета.
